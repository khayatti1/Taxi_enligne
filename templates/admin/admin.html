<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% block head %}{% endblock %}
    <script>
      $(document).ready(function () {
        $("#driver-table").DataTable();
      });
    </script>
  </head>
  <body>
    {% block body %}{% endblock %}
    <header class="mb-8 flex items-center justify-between md:mb-16 md:py-0 border-b-2 border-gray-500 md:px-8" style="height: 90px;">
      <img src="/static/images/login.png" class="max-h-[100px] h-[99px] w-[220px] rounded-full aspect-square object-cover px-4">
      <nav class="hidden gap-8 lg:flex">
          <a href="{{ url_for('admin') }}?conducteurs={{ conducteurs_inactifs|length }}" class="text-md font-semibold text-indigo-500">
          Demande conducteur ({{ conducteurs_inactifs|length }})</a>      
          <a href="{{ url_for('nos_conducteur') }}?conducteurs={{ conducteurs_actifs|length }}" class="text-md font-semibold text-gray-600 transition duration-100 hover:text-indigo-500 active:text-indigo-700">
            Nos conducteurs ({{ conducteurs_actifs|length }})
          </a>
           <a href="{{ url_for('nos_passager') }}?passagers={{ passagers|length }}" class="text-md font-semibold text-gray-600 transition duration-100 hover:text-indigo-500 active:text-indigo-700">
            Nos passagers ({{ passagers|length }})
          </a>
      </nav>
      <div class="relative inline-block text-left">
        <div>
          <button
            type="button"
            onclick="toggleMenu()"
            class="text-lg font-semibold px-6 py-2 inline-flex w-full justify-center gap-x-1.5 rounded-md bg-white text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 flex items-center"
            id="menu-button"
            aria-expanded="false"
            aria-haspopup="true"
          >
            Options
            <svg
              class="-mr-1 size-7 text-gray-400"
              viewBox="0 0 20 20"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>

        <div
          id="menu"
          class="hidden absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
          role="menu"
          aria-orientation="vertical"
          aria-labelledby="menu-button"
          tabindex="-1"
        >
          <div class="py-1" role="none">
            <a
              href="/logout"
              class="block px-4 py-2 text-sm text-gray-700"
              role="menuitem"
              tabindex="-1"
              id="menu-item-1"
              >Se Deconnecter</a
            >
          </div>
        </div>
      </div>
      <script>
        function toggleMenu() {
          const menu = document.getElementById("menu");
          menu.classList.toggle("hidden");
        }

        // Optionally, you can hide the menu when clicking outside of it
        document.addEventListener("click", function (event) {
          const menu = document.getElementById("menu");
          const button = document.getElementById("menu-button");
          if (!button.contains(event.target) && !menu.contains(event.target)) {
            menu.classList.add("hidden");
          }
        });
      </script>
    </header>

    <div class="relative overflow-x-auto shadow-md sm:rounded-lg m-4" style="margin-top: -40px;">
  <div class="flex items-center justify-between flex-column flex-wrap md:flex-row space-y-4 md:space-y-0 pb-4 bg-white :bg-gray-900">
    <div class="p-2">
        <div id="dropdownAction" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44 :bg-gray-700 :divide-gray-600">
            <ul class="py-1 text-sm text-gray-700 :text-gray-200" aria-labelledby="dropdownActionButton">
            </ul>
            <div class="py-1">
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 :hover:bg-gray-600 :text-gray-200 :hover:text-white">Delete User</a>
            </div>
        </div>
    </div>
    <label for="table-search" class="sr-only">Search</label>
    <div class="relative p-2">
        <div class="absolute inset-y-0 rtl:inset-r-0 start-0 flex items-center ps-5 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 :text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
        </div>
        <input type="text" id="table-search-users" class="block p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg w-80 bg-gray-50 focus:ring-blue-500 focus:border-blue-500 :bg-gray-700 :border-gray-600 :placeholder-gray-400 :text-white :focus:ring-blue-500 :focus:border-blue-500" placeholder="Search for users">
    </div>
</div>
      <table
        class="w-full text-sm text-left rtl:text-right text-gray-500 :text-gray-400"
      >
        <thead
          class="text-xs text-gray-700 uppercase bg-gray-50 :bg-gray-700 :text-gray-400"
        >
          <tr>
            <th scope="col" class="px-6 py-3">Image</th>
            <th scope="col" class="px-6 py-3">Nom Complet</th>
            <th scope="col" class="px-6 py-3">Telephone</th>
            <th scope="col" class="px-6 py-3">Voiture</th>
            <th scope="col" class="px-6 py-3">Permis</th>
            <th scope="col" class="px-6 py-3">Carte gris</th>
            <th scope="col" class="px-6 py-3">Matricule</th>
            <th scope="col" class="px-6 py-3">Type voiture</th>
            <th scope="col" class="px-6 py-3 text-end sr-only">Action</th>
          </tr>
        </thead>
        <tbody class="text-nowrap" id="drivers-table">
          {% for (driver, user) in conducteurs_inactifs %}
          <tr class="bg-white border-b :bg-gray-800 :border-gray-700">
            <th scope="row" class="px-6 py-4">
              <img
                src="static/images/{{user.img}}"
                class="max-h-[50px] h-[50px] w-[50px] rounded-full aspect-square object-cover"
              />
            </th>
            <td class="px-6 py-4">{{ user.name }}</td>
            <td class="px-6 py-4">+212 {{ user.phone }}</td>
            <td class="px-6 py-4">
              <a
                href="/static/images/{{ driver.voiture }}"
                download
                class="font-medium text-blue-600 :text-blue-500 hover:underline"
                >Telecharger</a
              >
            </td>
            <td class="px-6 py-4">
              <a
                href="/static/images/{{ driver.permis }}"
                download
                class="font-medium text-blue-600 :text-blue-500 hover:underline"
                >Telecharger</a
              >
            </td>
            <td class="px-6 py-4">
              <a
                href="/static/images/{{ driver.carte }}"
                download
                class="font-medium text-blue-600 :text-blue-500 hover:underline"
                >Telecharger</a
              >
            </td>
            <td class="px-6 py-4">{{ driver.mat }}</td>
            <td class="px-6 py-4">{{ driver.typev }}</td>
            <td class="px-6 py-4 text-right">
              <div class="flex justify-center items-center gap-2 h-full">
                <form action="/admin/accept" method="post" data-message="User Accepter">
                  <input type="hidden" name="id" value="{{ driver.user_id }}" />
                  <button
                    type="submit"
                    class="font-semibold text-green-500 bg-green-500/10 hover:bg-green-500 hover:text-white border border-green-500/30 px-4 py-1.5 duration-200 rounded-lg"
                  >
                    Accepter
                  </button>
                </form>
                <form action="/admin/refus" method="post" data-message="User deleted">
                  <input type="hidden" name="id" value="{{ driver.user_id }}" />
                  <button
                    type="submit"
                    class="font-semibold text-red-500 bg-red-500/10 hover:bg-red-500 hover:text-white border border-red-500/30 px-4 py-1.5 duration-200 rounded-lg"
                  >
                    Refuser
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script>
      var notyf = new Notyf();

      var formSubmit = () => {
        $("form").submit(function (event) {
          event.preventDefault();
          var serializedData = $(this).serialize();
          request = $.ajax({
            url: $(this).attr("action"),
            type: $(this).attr("method"),
            data: serializedData,
            success: (data) => {
              notyf.success($(this).data('message'));
              var table = "";
              for (let i = 0; i < data.length; i++) {
                const driver = data[i];
                console.log(data)
                table =
                  table +
                  '<tr class="bg-white border-b :bg-gray-800 :border-gray-700"><th scope="row" class="px-6 py-4"><img src="static/images/' +
                  driver.user.img +
                  '" class="max-h-[50px] h-[50px] w-[50px] rounded-full aspect-square object-cover" /></th><td class="px-6 py-4">' +
                  driver.user.name +
                  '</td><td class="px-6 py-4">+212 ' +
                  driver.user.phone +
                  '</td><td class="px-6 py-4"><a href="/static/images/' +
                  driver.voiture +
                  '" download class="font-medium text-blue-600 :text-blue-500 hover:underline">Telecharger</a></td><td class="px-6 py-4"><a href="/static/images/' +
                  driver.user.permis +
                  '" download class="font-medium text-blue-600 :text-blue-500 hover:underline">Telecharger</a></td><td class="px-6 py-4"><a href="/static/images/' +
                  driver.user.carte +
                  '" download class="font-medium text-blue-600 :text-blue-500 hover:underline">Telecharger</a></td><td class="px-6 py-4">23123-A-56</td><td class="px-6 py-4">SUV</td><td class="px-6 py-4 text-right"><div class="flex justify-center items-center gap-2 h-full"><form action="/admin/accept" method="post"><input type="hidden" name="id" value="' +
                  driver.user.id +
                  '" /><button type="submit" class="font-semibold text-green-500 bg-green-500/10 hover:bg-green-500 hover:text-white border border-green-500/30 px-4 py-1.5 duration-200 rounded-lg">Accepter</button></form><form action="/admin/refus" method="post"><input type="hidden" name="id" value="' +
                  driver.user.id +
                  '" /><button type="submit" class="font-semibold text-red-500 bg-red-500/10 hover:bg-red-500 hover:text-white border border-red-500/30 px-4 py-1.5 duration-200 rounded-lg">Refuser</button></form></div></td></tr>';
                $("tbody").html(table);
                $('#table-search-users').val('')
                formSubmit();
              }
            },
            error: (e) => {
              notyf.error(e.responseJSON.error);
            },
          });
        });
      };

      formSubmit();

      document.getElementById('table-search-users').addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#drivers-table tr');

            rows.forEach(row => {
                const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const phone = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const voiture = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                const permis = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
                const carte = row.querySelector('td:nth-child(6)').textContent.toLowerCase();
                const etat = row.querySelector('td:nth-child(7)').textContent.toLowerCase();

                if (name.includes(searchTerm) || phone.includes(searchTerm) || voiture.includes(searchTerm) || permis.includes(searchTerm) || carte.includes(searchTerm) || etat.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    </script>
  </body>
</html>
